<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ /*
  ~ * JBoss, Home of Professional Open Source.
  ~ * Copyright 2014, Red Hat, Inc., and individual contributors
  ~ * as indicated by the @author tags. See the copyright.txt file in the
  ~ * distribution for a full listing of individual contributors.
  ~ *
  ~ * This is free software; you can redistribute it and/or modify it
  ~ * under the terms of the GNU Lesser General Public License as
  ~ * published by the Free Software Foundation; either version 2.1 of
  ~ * the License, or (at your option) any later version.
  ~ *
  ~ * This software is distributed in the hope that it will be useful,
  ~ * but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  ~ * Lesser General Public License for more details.
  ~ *
  ~ * You should have received a copy of the GNU Lesser General Public
  ~ * License along with this software; if not, write to the Free
  ~ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  ~ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
  ~ */
  -->


<!--
    1. The testsuite module has a small number of submodules:

    integration - holds all integration tests for Wildfly.
    compat      - holds all compatibility management tests for Wildfly.
    domain      - holds all domain management tests for Wildfly.

    All tests should fit into one of these four categories.

    2. This pom is inherited by all submodules and should be used to do the following:
       - Set defaults for common testsuite system properties (which can then be overridden on the command line).
       - Define dependencies common to all tests (Arquillian, junit or testng, and container type).
       - Provide a workaround for @Resource(lookup=...) which requires libraries in jbossas/endorsed.
       - Define a default server configuration installed into target/jboasas in each submodule, which
         represents an unmodified copy of the AS server. Custom server configurations are defined in the submodules.
       - Define profiles to allow selection of which test modules will be executed.

    3. This pom should not be used to do the following:
       - Define module-specific server configuration build steps.
       - Define module-specific surefire executions.
       These elements should be defined in logical profiles associated with each logical grouping of tests,
       in the pom for the module which contains the tests. See the submodule poms for more details.

-->

<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.wildfly.core</groupId>
        <artifactId>wildfly-core-parent</artifactId>
        <version>1.0.0.Alpha3-SNAPSHOT</version>
    </parent>

    <groupId>org.wildfly.core</groupId>
    <artifactId>wildfly-core-testsuite</artifactId>
    <version>1.0.0.Alpha3-SNAPSHOT</version>
    <packaging>pom</packaging>

    <name>WildFly core Test Suite: Aggregator</name>

    <modules>
        <module>shared</module>
        <module>test-runner</module>
        <module>standalone</module>
    </modules>


    <!-- Global testsuite system properties defaults. -->

    <properties>
        <!-- Current module's directory. Will automatically pick up sub-module's basedir. -->
        <jbossas.ts.submodule.dir>${basedir}</jbossas.ts.submodule.dir>
        <!-- Integration module's directory. To be overriden in sub-modules. -->
        <!-- This project's testsuite dir. To be changed for every submodule (until we figure out how to do it automatically). -->
        <jbossas.ts.dir>${basedir}</jbossas.ts.dir>
        <!-- This project's root dir. -->
        <jbossas.project.dir>${jbossas.ts.dir}/..</jbossas.project.dir>


        <!-- Used to provide an absolute location for the distribution under test. -->
        <!-- This value is overridden in modules with the correct relative pathname. -->
        <jboss.dist>${project.basedir}/../${wildfly.core.build.output.dir}</jboss.dist>
        <jboss.home>${jboss.dist}</jboss.home>

        <!-- Used to provide an absolute location for the XSLT scripts. -->
        <!-- This value is overridden in modules with the correct relative pathname. -->
        <xslt.scripts.dir>${basedir}/src/test/xslt</xslt.scripts.dir>

        <!-- IP address defaults. -->
        <node0>127.0.0.1</node0>
        <node1>127.0.0.1</node1>
        <mcast>230.0.0.4</mcast>
        <!-- Default multicast address. -->

        <!-- additional IP address defaults for xsite clustering tests -->
        <node2>127.0.0.1</node2>
        <node3>127.0.0.1</node3>
        <mcast1>230.0.0.5</mcast1>
        <mcast2>230.0.0.6</mcast2>
        <mcast3>230.0.0.7</mcast3>

        <!-- IP stack configs. -->
        <jvm.args.ip>-Djava.net.preferIPv4Stack=true -Djava.net.preferIPv6Addresses=false</jvm.args.ip>
        <jvm.args.ip.server>${jvm.args.ip}</jvm.args.ip.server>
        <jvm.args.ip.client>${jvm.args.ip}</jvm.args.ip.client>

        <!-- Security. -->
        <jvm.args.securityManager></jvm.args.securityManager>
        <jvm.args.securityPolicy></jvm.args.securityPolicy>
        <jvm.args.securityManagerOther></jvm.args.securityManagerOther>
        <jvm.args.security>${jvm.args.securityManager} ${jvm.args.securityPolicy} ${jvm.args.securityManagerOther}</jvm.args.security>

        <!-- Additional JVM args, like those for EC2. -->
        <jvm.args.other>-server</jvm.args.other>


        <!-- Logging config -->
        <testLogToFile>true</testLogToFile>

        <!-- Timeout ratios. 100 will leave the timeout as it was coded. -->
        <timeout.factor>100</timeout.factor>
        <jvm.args.timeouts>-Dts.timeout.factor=${timeout.factor}</jvm.args.timeouts>


        <!-- Common surefire properties. -->
        <surefire.memory.args>-Xmx512m -XX:MaxPermSize=256m</surefire.memory.args>
        <surefire.jpda.args></surefire.jpda.args>
        <as.debug.port>8787</as.debug.port>
        <surefire.system.args>${surefire.memory.args} ${surefire.jpda.args} -Djboss.dist=${jboss.dist}</surefire.system.args>
        <surefire.forked.process.timeout>1500</surefire.forked.process.timeout>

        <!-- If servers should be killed before the test suite is run-->
        <org.wildfly.test.kill-servers-before-test>false</org.wildfly.test.kill-servers-before-test>

        <!-- Arquillian dependency versions -->
        <version.arquillian_wildfly>${project.parent.version}</version.arquillian_wildfly>
        <version.saxon>8.7</version.saxon>

        <!-- Don't try to deploy the testsuite modules because they don't build jars -->
        <maven.deploy.skip>true</maven.deploy.skip>

        <!-- used to enable trace logging for test suite runs -->
        <trace>none</trace>

    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.wildfly.core</groupId>
                <artifactId>wildfly-core-testsuite-shared</artifactId>
                <version>${project.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.wildfly.core</groupId>
            <artifactId>wildfly-controller</artifactId>
        </dependency>

        <dependency>
            <groupId>org.wildfly.core</groupId>
            <artifactId>wildfly-host-controller</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jboss.logging</groupId>
            <artifactId>jboss-logging-annotations</artifactId>
            <scope>compile</scope>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <build>


        <pluginManagement>
            <plugins>

                <!--
                    A build of target/wildfly-core which is shared by all modules.
                    Modules and bundles are not copied as they are read-only (see surefire props).
                -->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-resources-plugin</artifactId>
                    <executions combine.children="append">
                        <!-- Copy the AS into current_submodule/target/wildfly-core . This is executed recursively in submodules. -->
                        <execution>
                            <id>ts.copy-jbossas.groups</id>
                            <inherited>true</inherited>
                            <phase>generate-test-resources</phase>
                            <goals>
                                <goal>copy-resources</goal>
                            </goals>
                            <configuration>
                                <outputDirectory>${basedir}/target/wildfly-core</outputDirectory>
                                <overwrite>true</overwrite>
                                <resources>
                                    <resource>
                                        <directory>${jboss.home}</directory>
                                        <excludes>
                                            <exclude>modules/</exclude>
                                            <exclude>standalone/data</exclude>
                                            <exclude>standalone/log</exclude>
                                            <exclude>standalone/tmp</exclude>
                                        </excludes>
                                    </resource>
                                </resources>
                            </configuration>
                        </execution>
                    </executions>
                </plugin>

                <!--
                    Adjust IP addresses used in server config files.
                 -->
                <plugin>
                    <groupId>org.codehaus.mojo</groupId>
                    <artifactId>xml-maven-plugin</artifactId>
                    <executions combine.children="append">
                        <execution>
                            <id>ts.config-as.ip</id>
                            <phase>process-test-resources</phase>
                            <goals>
                                <goal>transform</goal>
                            </goals>
                            <inherited>true</inherited>
                            <configuration>
                                <transformationSets>
                                    <!-- IPs. -->
                                    <transformationSet>
                                        <dir>${basedir}/target/wildfly-core/standalone/configuration</dir>
                                        <outputDir>${basedir}/target/wildfly-core/standalone/configuration</outputDir>
                                        <stylesheet>${xslt.scripts.dir}/changeIPAddresses.xsl</stylesheet>
                                        <includes>
                                            <include>standalone*.xml</include>
                                        </includes>
                                        <parameters>
                                            <parameter>
                                                <name>managementIPAddress</name>
                                                <value>${node0}</value>
                                            </parameter>
                                            <parameter>
                                                <name>publicIPAddress</name>
                                                <value>${node0}</value>
                                            </parameter>

                                            <parameter>
                                                <name>udpMcastAddress</name>
                                                <value>${mcast}</value>
                                            </parameter>
                                            <parameter>
                                                <name>mpingMcastAddress</name>
                                                <value>${mcast}</value>
                                            </parameter>
                                            <parameter>
                                                <name>modclusterMcastAddress</name>
                                                <value>${mcast}</value>
                                            </parameter>
                                        </parameters>
                                    </transformationSet>
                                </transformationSets>
                            </configuration>
                        </execution>
                        <execution>
                            <id>ts.config-as.trace-logging</id>
                            <phase>process-test-resources</phase>
                            <goals>
                                <goal>transform</goal>
                            </goals>
                            <inherited>true</inherited>
                            <configuration>
                                <transformationSets>
                                    <!-- IPs. -->
                                    <transformationSet>
                                        <dir>${basedir}/target/wildfly-core/standalone/configuration</dir>
                                        <outputDir>${basedir}/target/wildfly-core/standalone/configuration</outputDir>
                                        <stylesheet>${xslt.scripts.dir}/enableTrace.xsl</stylesheet>
                                        <includes>
                                            <include>standalone*.xml</include>
                                        </includes>
                                        <parameters>
                                            <parameter>
                                                <name>trace</name>
                                                <value>${trace}</value>
                                            </parameter>
                                        </parameters>
                                    </transformationSet>
                                </transformationSets>
                            </configuration>
                        </execution>
                    </executions>
                    <!-- WFLY-3361 - use external xalan for XML transformations to
                    ensure consistent behaviour on all platrforms.-->
                    <dependencies>
                        <dependency>
                            <groupId>xalan</groupId>
                            <artifactId>xalan</artifactId>
                            <version>2.7.1</version>
                        </dependency>
                    </dependencies>
                </plugin>

                <!-- WFLY-3361 - use external xalan for XML transformations to
                ensure consistent behaviour on all platrforms.-->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-antrun-plugin</artifactId>
                    <dependencies>
                        <dependency>
                            <groupId>xalan</groupId>
                            <artifactId>xalan</artifactId>
                            <version>2.7.1</version>
                        </dependency>
                    </dependencies>
                </plugin>

                <!--
                   Sets general surefire system properties.
                   These can be overridden by inheriting plugin configurations.
                -->

                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-surefire-plugin</artifactId>
                    <configuration>
                        <failIfNoTests>false</failIfNoTests>
                        <redirectTestOutputToFile>${testLogToFile}</redirectTestOutputToFile>
                        <systemPropertyVariables>
                            <jboss.options>${surefire.system.args}</jboss.options>
                            <java.util.logging.manager>org.jboss.logmanager.LogManager</java.util.logging.manager>
                            <jboss.dist>${jboss.dist}</jboss.dist>
                            <jboss.home>${basedir}/target/wildfly-core</jboss.home>
                            <org.wildfly.test.kill-servers-before-test>${org.wildfly.test.kill-servers-before-test}</org.wildfly.test.kill-servers-before-test>
                        </systemPropertyVariables>
                        <!-- Arquillian's config files. -->
                        <additionalClasspathElements combine.children="append">
                            <additionalClasspathElement>${basedir}/src/test/config/arq</additionalClasspathElement>
                        </additionalClasspathElements>
                    </configuration>
                </plugin>

                <!-- Disable default site run. -->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-site-plugin</artifactId>
                    <executions>
                        <execution>
                            <id>default-site</id>
                            <phase>none</phase>
                        </execution>
                    </executions>
                </plugin>

                <!-- Don't create jars - nothing to do. -->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-jar-plugin</artifactId>
                    <executions>
                        <execution>
                            <id>default-jar</id>
                            <phase>none</phase>
                        </execution>
                    </executions>
                </plugin>
                <!-- Don't install - nothing to do. -->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-install-plugin</artifactId>
                    <executions>
                        <execution>
                            <id>default-install</id>
                            <phase>none</phase>
                        </execution>
                    </executions>
                </plugin>
            </plugins>
        </pluginManagement>
    </build>


    <profiles>
        <profile>
            <id>domain.core.test</id>
            <activation>
                <property>
                    <name>ts.domain</name>
                </property>
            </activation>
            <modules>
                <module>domain</module>
            </modules>
        </profile>

        <profile>
            <id>all-modules.module.profile</id>
            <activation>
                <property>
                    <name>allTests</name>
                </property>
            </activation>
            <modules>
                <module>patching</module>
                <module>domain</module>
            </modules>
        </profile>

        <!--
          Debugging profiles.
        -->
        <profile>
            <id>jpda.profile</id>
            <activation>
                <property>
                    <name>jpda</name>
                </property>
            </activation>
            <properties>
                <surefire.jpda.args>-agentlib:jdwp=transport=dt_socket,address=${as.debug.port},server=y,suspend=y</surefire.jpda.args>
            </properties>
        </profile>

        <!-- IPv6. Wildfly-2228. -->
        <profile>
            <id>ts.ipv6</id>
            <activation>
                <property>
                    <name>ipv6</name>
                </property>
            </activation>
            <properties>
                <jvm.args.ip>-Djava.net.preferIPv4Stack=false -Djava.net.preferIPv6Addresses=true</jvm.args.ip>

                <!-- Override IPv4 defaults from the top. -->
                <node0>::1</node0>
                <node1>::1</node1>
                <mcast>ff01::1</mcast>
                <!-- ff01::1  is IPv6 Node-Local scope mcast addr. -->

                <!-- Override xsite IPv4 defaults from the top.  -->
                <node2>::1</node2>
                <node3>::1</node3>
                <mcast1>ff01::2</mcast1>
                <mcast2>ff01::3</mcast2>
                <mcast3>ff01::4</mcast3>

            </properties>
        </profile>
        <!-- Ugly workaround for MANTRUN-172 :/   See Wildfly-3993. -->
        <profile>
            <id>ts.ipv6.dummy.node0</id>
            <activation>
                <property>
                    <name>node0</name>
                </property>
            </activation>
            <properties>
                <node0>${node0}</node0>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.node1</id>
            <activation>
                <property>
                    <name>node1</name>
                </property>
            </activation>
            <properties>
                <node1>${node1}</node1>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.mcast</id>
            <activation>
                <property>
                    <name>mcast</name>
                </property>
            </activation>
            <properties>
                <mcast>${mcast}</mcast>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.node2</id>
            <activation>
                <property>
                    <name>node2</name>
                </property>
            </activation>
            <properties>
                <node2>${node2}</node2>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.node3</id>
            <activation>
                <property>
                    <name>node3</name>
                </property>
            </activation>
            <properties>
                <node3>${node3}</node3>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.mcast1</id>
            <activation>
                <property>
                    <name>mcast1</name>
                </property>
            </activation>
            <properties>
                <mcast1>${mcast1}</mcast1>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.mcast2</id>
            <activation>
                <property>
                    <name>mcast2</name>
                </property>
            </activation>
            <properties>
                <mcast2>${mcast2}</mcast2>
            </properties>
        </profile>
        <profile>
            <id>ts.ipv6.dummy.mcast3</id>
            <activation>
                <property>
                    <name>mcast3</name>
                </property>
            </activation>
            <properties>
                <mcast3>${mcast3}</mcast3>
            </properties>
        </profile>


        <!-- Security policy.  ARQ-690, Wildfly-2823, Wildfly-2826. -->
        <profile>
            <id>ts.security.policy</id>
            <activation>
                <property>
                    <name>security.policy</name>
                </property>
            </activation>
            <properties>
                <jvm.args.securityManager>-Djava.security.manager</jvm.args.securityManager>
                <jvm.args.securityPolicy>-Djava.security.policy=${security.policy}</jvm.args.securityPolicy>
            </properties>
        </profile>

        <!-- Security Manager Other -->
        <profile>
            <id>ts.security.manager.other</id>
            <activation>
                <property>
                    <name>security.manager.other</name>
                </property>
            </activation>
            <properties>
                <jvm.args.securityManagerOther>${security.manager.other}</jvm.args.securityManagerOther>
            </properties>
        </profile>
        <!-- -Dts.patching -->
        <profile>
            <id>ts.integ.group.patching</id>
            <activation>
                <property>
                    <name>ts.patching</name>
                </property>
            </activation>
            <modules>
                <module>patching</module>
            </modules>
        </profile>


    </profiles>
</project>
